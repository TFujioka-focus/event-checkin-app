<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>チェックイン</title>
    <style>
        :root {
            --pad: 14px;
            --radius: 14px;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
            background: #f6f7f9;
            color: #111827;
        }

        .wrap {
            max-width: 560px;
            margin: 0 auto;
            padding: var(--pad);
        }

        .card {
            background: #fff;
            border-radius: var(--radius);
            padding: var(--pad);
            box-shadow: 0 2px 10px rgba(0, 0, 0, .06);
            margin: 12px 0;
        }

        h1 {
            font-size: 18px;
            margin: 0 0 10px;
        }

        label {
            display: block;
            font-size: 12px;
            color: #374151;
            margin: 10px 0 6px;
        }

        input,
        button {
            width: 100%;
            font-size: 16px;
            padding: 12px;
            border-radius: 12px;
            box-sizing: border-box;
        }

        input {
            border: 1px solid #d1d5db;
        }

        button {
            border: 0;
            font-weight: 800;
            cursor: pointer;
            background: #111827;
            color: #fff;
        }

        .meta {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.6;
            word-break: break-all;
        }

        .status {
            margin-top: 12px;
            border-radius: 14px;
            padding: 14px;
            font-weight: 900;
            text-align: center;
        }

        .ok {
            background: #eaf7ef;
            color: #065f46;
        }

        .dup {
            background: #fff7ed;
            color: #9a3412;
        }

        .err {
            background: #fef2f2;
            color: #991b1b;
        }

        .small {
            font-size: 12px;
            color: #6b7280;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="card">
            <h1>チェックイン</h1>
            <div class="meta">
                参加者の方がこのページで <b>ユーザーID</b> を入力してチェックインします。
            </div>
            <div class="meta" style="margin-top:10px;">
                イベント：<b id="eventLabel">-</b>
            </div>
        </div>

        <div class="card">
            <label>ユーザーID</label>
            <input id="userId" placeholder="例：U001" inputmode="text" autocomplete="off" />

            <div style="height:12px"></div>
            <button id="submitBtn">チェックイン</button>

            <div id="statusBox" class="status" style="display:none;"></div>
            <div class="small" id="hint"></div>
        </div>

        <div class="card">
            <div class="meta">
                ※ チェックイン済みの場合は「チェックイン済み」と表示されます。<br />
                ※ 通信状況により時間がかかる場合があります。
            </div>
        </div>
    </div>

    <script>
        // ========= 設定 =========
        const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyIxjMYCvakytLlQ48MZYC8CNFRkeVQvN_7pJL0LJUn10h3Pn86RjOgYKRarlM-OJTH/exec";
        const API_KEY = "plt2026_9fK3dA2xQmL8"; // GAS側と同じ。不要なら空文字でもOK
        const EVENT_ID = "training-260129"; // イベントID
        // =====================================

        const $ = (id) => document.getElementById(id);
        const statusBox = $("statusBox");
        const hint = $("hint");

        // イベントIDを表示
        $("eventLabel").textContent = EVENT_ID;

        function setStatus(kind, msg, detail) {
            statusBox.style.display = "block";
            statusBox.className = "status " + kind;
            statusBox.innerHTML = msg + (detail ? `<div style="font-weight:700; margin-top:6px; font-size:12px; opacity:.9">${detail}</div>` : "");
        }

        function clearStatusSoon(ms = 1800) {
            setTimeout(() => {
                statusBox.style.display = "none";
                hint.textContent = "";
            }, ms);
        }

        // 「チェックイン」音（簡易チャイム）
        function playCheckinSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const now = ctx.currentTime;

                const o1 = ctx.createOscillator();
                const g1 = ctx.createGain();
                o1.type = "sine";
                o1.frequency.setValueAtTime(880, now);
                g1.gain.setValueAtTime(0.0001, now);
                g1.gain.exponentialRampToValueAtTime(0.06, now + 0.01);
                g1.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);
                o1.connect(g1); g1.connect(ctx.destination);
                o1.start(now); o1.stop(now + 0.2);

                const o2 = ctx.createOscillator();
                const g2 = ctx.createGain();
                o2.type = "sine";
                o2.frequency.setValueAtTime(1320, now + 0.08);
                g2.gain.setValueAtTime(0.0001, now + 0.08);
                g2.gain.exponentialRampToValueAtTime(0.05, now + 0.10);
                g2.gain.exponentialRampToValueAtTime(0.0001, now + 0.26);
                o2.connect(g2); g2.connect(ctx.destination);
                o2.start(now + 0.08); o2.stop(now + 0.28);

                setTimeout(() => ctx.close(), 400);
            } catch { }
        }

        // JSONP方式でCORSを完全に回避
        function postCheckin(event_id, user_id) {
            return new Promise((resolve, reject) => {
                const payload = {
                    apiKey: API_KEY,
                    event_id,
                    user_id
                };

                console.log("送信データ:", payload);
                console.log("送信先:", GAS_ENDPOINT);

                // コールバック関数名を生成
                const callbackName = 'gasCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                // グローバルスコープにコールバック関数を設定
                window[callbackName] = function (data) {
                    console.log("JSONPレスポンス:", data);
                    // コールバック関数とscriptタグを削除
                    delete window[callbackName];
                    document.head.removeChild(script);
                    clearTimeout(timeoutId);
                    resolve(data);
                };

                // タイムアウト設定
                const timeoutId = setTimeout(() => {
                    delete window[callbackName];
                    if (script.parentNode) {
                        document.head.removeChild(script);
                    }
                    reject(new Error("リクエストがタイムアウトしました"));
                }, 10000);

                // URLパラメータを構築
                const params = new URLSearchParams({
                    apiKey: API_KEY,
                    event_id: event_id,
                    user_id: user_id,
                    callback: callbackName
                });

                const url = `${GAS_ENDPOINT}?${params.toString()}`;
                console.log("リクエストURL:", url);

                // scriptタグを作成して追加
                const script = document.createElement('script');
                script.src = url;
                script.onerror = function () {
                    delete window[callbackName];
                    document.head.removeChild(script);
                    clearTimeout(timeoutId);
                    reject(new Error("ネットワークエラー: GAS Webアプリに接続できません。"));
                };
                document.head.appendChild(script);
            });
        }

        // Enterキーで送信
        $("userId").addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !$("submitBtn").disabled) {
                $("submitBtn").click();
            }
        });

        $("submitBtn").addEventListener("click", async () => {
            const userId = $("userId").value.trim();

            if (!userId) {
                setStatus("err", "ユーザーIDを入力してください");
                return;
            }

            $("submitBtn").disabled = true;
            $("submitBtn").textContent = "送信中...";
            hint.textContent = "";

            try {
                const data = await postCheckin(EVENT_ID, userId);
                const st = String(data.status || data.result || "").toUpperCase();

                // チェックイン成功
                if (data.success !== false && (st === "OK" || st === "SUCCESS")) {
                    playCheckinSound();
                    setStatus("ok", "チェックイン完了", `ユーザーID：${userId}`);
                    $("userId").value = "";
                    clearStatusSoon(3000);
                }
                // チェックイン済み
                else if (st === "DUPLICATE" || st === "ALREADY_CHECKED_IN") {
                    setStatus("dup", "チェックイン済みです", `ユーザーID：${userId}`);
                }
                // ユーザーIDが見つからない
                else if (st === "NOT_FOUND" || st === "USER_NOT_FOUND") {
                    setStatus("err", "ユーザーIDが見つかりません", `ユーザーID：${userId} が登録されていません`);
                }
                // 認証エラー
                else if (st === "UNAUTHORIZED" || st === "AUTH_ERROR") {
                    setStatus("err", "認証エラー", "APIキーを確認してください");
                }
                // その他のエラー
                else {
                    const errorMsg = data.message || data.error || data.raw || "不明なエラー";
                    setStatus("err", "エラー", errorMsg.toString().slice(0, 120));
                }
            } catch (e) {
                console.error("エラー詳細:", e);
                const errorMsg = e.message || String(e);
                let hint = "";

                if (errorMsg.includes("CORS") || errorMsg.includes("cors")) {
                    hint = "CORSエラー: GAS Webアプリの設定を確認してください";
                } else if (errorMsg.includes("ネットワーク")) {
                    hint = "ネットワーク接続を確認してください";
                } else if (errorMsg.includes("fetch")) {
                    hint = "GAS WebアプリのURLを確認してください";
                }

                setStatus("err", "通信エラー", errorMsg + (hint ? `<br/><small>${hint}</small>` : ""));
                hint.textContent = "ブラウザのコンソール（F12）で詳細を確認できます";
            } finally {
                $("submitBtn").disabled = false;
                $("submitBtn").textContent = "チェックイン";
            }
        });
    </script>
</body>

</html>
